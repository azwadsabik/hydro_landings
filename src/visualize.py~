# -*- coding: utf-8 -*-
"""
Created on Sat May  7 16:55:11 2016

@author: sabik
"""

import rospy
import cv_bridge
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.animation as animation
from geometry_msgs.msg import Pose
from sensor_msgs.msg import Image
from ardrone_autonomy.msg import Navdata
import time

bridge = cv_bridge.CvBridge()

xmax = rospy.get_param("/cage_x")*0.3048/2
ymax = rospy.get_param("/cage_y")*0.3048/2
marker_x_rels = np.array([-3, -1, 1, 3])/8.0
marker_y_rels = np.array([2, 0, -2])/6.0
marker_x = []
marker_y = []

for y_rel in marker_y_rels:
	for x_rel in marker_x_rels:
		x = x_rel*xmax*2
		y = y_rel*ymax*2
		marker_x.append(x)
		marker_y.append(y)

zmax = 4
history = 1000

fig = plt.figure()
planar = fig.add_subplot(2, 2, 1)
image_plot = fig.add_subplot(2, 2, 2)
x_plot = fig.add_subplot(2, 3, 4)
y_plot = fig.add_subplot(2, 3, 5)
z_plot = fig.add_subplot(2, 3, 6)

estimate_time = []
navdata_time = []

x = []
y = []
z = []
z_truth []
im = np.eye(500, 500)

def update_vis(estimate):
    global n    
    n += 1
    x.append(estimate.position.x)
    y.append(estimate.position.y)
    z.append(estimate.position.z)
    estimate_time.append(time.time())
    if len(x) > history:
        x.pop(0)
        y.pop(0)
        z.pop(0)
        estimate_time.pop(0)
    
def update_im(img_msg):
	global im
	im = bridge.imgmsg_to_cv2(img_msg, desired_encoding="passthrough")

def update_alt(navdata):
    z_truth.append(navdata.altd)
    navdata_time.append(time.time())
    if len(z_truth) > history:
        z_truth.pop(0)
        navdata_time.pop(0)
    
def animate(i):
    time_min = min(min(estimate_time), min(navdata_time))
    time_max = max(max(estimate_time), max(navdata_time))
    planar.clear()
    image_plot.clear()
    x_plot.clear()
    y_plot.clear()
    z_plot.clear()
    planar.set_xlim((-xmax, xmax))
    planar.set_ylim((-ymax, ymax))
    x_plot.set_ylim((-xmax, xmax))
    x_plot.set_xlim((0, 1000))
    y_plot.set_ylim((-ymax, ymax))
    y_plot.set_xlim((0, 1000))
    z_plot.set_ylim((-zmax, zmax))
    z_plot.set_xlim((0, 1000))
    planar.scatter(x[-1],y[-1])
    planar.scatter(marker_x, marker_y, color='red')
    x_plot.plot(estimate_time, x)
    y_plot.plot(estimate_time, y)
    z_plot.plot(estimate_time, z)
    z_plot.plot(estimate_time, z_truth, 'g')
    image_plot.imshow(im)

if __name__ == "__main__":
    rospy.init_node('pose_estimate_visualization')
    pose_estimator = rospy.Subscriber("/pose_estimate", Pose, update_vis)
    image_viewer = rospy.Subscriber("/ardrone/image_raw", Image, update_im)
    navdata_sub = rospy.Subscriber('/ardrone/navdata',Navdata,update_alt) 
    ani = animation.FuncAnimation(fig, animate, interval=1000)
    plt.show()

    pass
